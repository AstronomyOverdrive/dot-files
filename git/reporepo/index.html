<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>RepoRepo</title>
	<style>
		html {
			background: #242424;
		}
		body {
			margin: 0;
			background: #404040;
			color: #F1F1F1;
			font-family: sans-serif;
			font-size: 1rem;
			min-height: 100vh;
		}
		h1 {
			background: black;
			margin: 0;
			padding: 0.5em;
		}
		h1 a, h1 a:visited {
			color: darkgreen;
			text-decoration: none;
		}
		h1 span {
			color: darkred;
		}
		h1 a:hover {
			color: forestgreen;
		}
		h1 a span:hover {
			color: red;
		}
		h2 {
			margin-bottom: 0.2em;
		}
		input {
			margin-bottom: 0.5em;
		}
		table {
			border-collapse: collapse;
			border: 1px solid white;
			font-family: monospace;
			color: black;
			width: 100%;
		}
		th, td {
			padding: 0.5em;
			padding-left: 1em;
			padding-right: 1em;
		}
		thead {
			text-align: left;
			background: cornflowerblue;
		}
		:nth-child(even of tbody tr) {
			background: aliceblue;
		}
		:nth-child(odd of tbody tr) {
			background: lightblue;
		}
		tbody tr:hover {
			background: cornsilk;
		}
		.delBtn {
			background: none;
			color: red;
			border: 2px solid red;
			border-radius: 50%;
			font-weight: bold;
			font-family: monospace;
		}
		.delBtn:hover {
			color: black;
			border-color: black;
			background: tomato;
		}
		.infoBtn {
			font-size: 1rem;
			padding: 0;
			margin: 0;
			border: none;
			color: blue;
			background: none;
			text-decoration: underline;
		}
		.infoBtn:hover {
			color: darkblue;
		}
		section {
			position: relative;
		}
		#infoBox {
			position: absolute;
			top: 0;
			left: 0;
			min-height: 100%;
			width: 100%;
			color: black;
			background: white;
			display: none;
		}
		@media only screen and (orientation: landscape) {
			main {
				width: 70%;
				margin-left: 15%;
			}
		}
		@media only screen and (orientation: portrait) {
			main {
				width: 90%;
				margin-left: 5%;
			}
		}
		@media only screen and (max-width: 600px) {
			.nomobile {
				display: none;
			}
		}
		@media only screen and (min-aspect-ratio: 21 / 9) {
			body {
				max-width: calc(100vh * 1.777);
				margin-left: calc((100% - (100vh * 1.777)) / 2);
			}
		}
	</style>
</head>

<body>
	<header>
		<h1><a href="https://github.com/AstronomyOverdrive/dot-files/tree/main/git/reporepo" target="_blank">Repo<span>Repo</span></a></h1>
	</header>

	<main>
		<section>
			<h2>New</h2>
			<form>
				<label for="name">Name: </label>
				<input type="text" name="name" id="name" value="Couldn't connect to server!" placeholder="A-Za-z0-9-_">
				<button id="new" type="button">Create</button>
			</form>
		</section>
		<section>
			<h2>Repos</h2>
			<label for="search">Search: </label>
			<input type="text" name="search" id="search" placeholder="Name...">
			<table>
				<thead>
					<tr>
						<th>Delete</th>
						<th>Name</th>
						<th class="nomobile">Clone</th>
						<th>Info</th>
					</tr>
				</thead>
				<tbody id="repos"></tbody>
			</table>
			<div id="infoBox">
				<div style="margin: 1em;">
					<button id="closeInfoBtn">Close</button>
					<h3 id="infoHeader">Git</h3>
					<strong>Latest commit:</strong>
					<p id="commitP"></p>
					<strong>Files:</strong>
					<p id="filesP"></p>
				</div>
			</div>
		</section>
	</main>

	<script>
		"use strict";

		let ip = "";
		let port = "";
		let cooldownActive = false;
		let baseUrl = "";
		let allRepos;
		const createBtn = document.getElementById("new");
		const nameInput = document.getElementById("name");
		const searchInput = document.getElementById("search");
		const repoTable = document.getElementById("repos");
		const infoBox = document.getElementById("infoBox");
		const closeInfoBtn = document.getElementById("closeInfoBtn");
		const commitP = document.getElementById("commitP");
		const filesP = document.getElementById("filesP");
		const infoHeader = document.getElementById("infoHeader");

		function fetchData() {
			fetch("settings.json")
				.then((response) => response.json())
				.then((data) => {
					// Update connection details
					ip = data.ip;
					port = data.wsPort;
					// Update repo list
					const Socket = new WebSocket(`ws://${ip}:${port}`);
					Socket.addEventListener("open", (event) => {
						Socket.send(JSON.stringify({action: "fetch", name: ""}));
						Socket.addEventListener("message", (event) => {
							const serverData = JSON.parse(event.data);
							baseUrl = serverData.url;
							allRepos = serverData.repos.split("\n");
							fillTable(allRepos);
							nameInput.value = "";
							createBtn.disabled = false;
							cooldownActive = false;
							closeInfo();
							Socket.close();
						});
					});
				})
				.catch((error) => console.log(error));
		}

		function fillTable(repos) {
			repoTable.innerHTML = "";
			repos.forEach(repo => {
				if (repo !== "") {
					repoTable.innerHTML +=
						`<tr>
							<td><button onclick="deleteRepo('${repo}')" class="delBtn">X</button></td>
							<td>${repo}</td>
							<td class="nomobile">git clone ${baseUrl}${repo}</td>
							<td><button onclick="getInfo('${repo}')" class="infoBtn">show</td>
						</tr>`;
					}
			});
		}

		function getInfo(repo) {
			const Socket = new WebSocket(`ws://${ip}:${port}`);
			Socket.addEventListener("open", (event) => {
				const name = cleanName(repo);
				Socket.send(JSON.stringify({action: "info", name: name}));
				Socket.addEventListener("message", (event) => {
					const serverData = JSON.parse(event.data);
					infoHeader.textContent = name;
					commitP.innerText = serverData.commit;
					filesP.innerText = serverData.files;
					infoBox.style.display = "block";
					Socket.close();
				});
			});
		}

		function closeInfo() {
			infoBox.style.display = "none";
		}

		function createRepo() {
			if (typeof allRepos !== "undefined") {
				const name = cleanName(nameInput.value);
				sendCmd(JSON.stringify({action: "create", name: name}));
			}
		}

		function deleteRepo(repo) {
			const name = cleanName(repo);
			sendCmd(JSON.stringify({action: "delete", name: name}));
		}

		function cleanName(name) {
			return name.replaceAll(/[^A-Za-z0-9-_]/g, "");
		}

		function sendCmd(command) {
			if (!cooldownActive) {
				cooldownActive = true;
				createBtn.disabled = true;
				const Socket = new WebSocket(`ws://${ip}:${port}`);
				Socket.addEventListener("open", (event) => {
					Socket.send(command);
					setTimeout(() => {
						fetchData();
					}, 1000); // Wait a bit to let server run commands
					Socket.close();
				});
			}
		}

		function filterRepos() {
			if (typeof allRepos !== "undefined") {
				const phrase = searchInput.value;
				let showRepos = allRepos.filter(name => name.includes(phrase));
				fillTable(showRepos);
			}
		}

		createBtn.addEventListener("click", createRepo);
		closeInfoBtn.addEventListener("click", closeInfo);
		searchInput.addEventListener("keyup", filterRepos);
		createBtn.disabled = true;
		fetchData();
	</script>
</body>

</html>
